# ICSⅠ Lab5 报告

计算机科学与技术
19307130296
孙若诗

## eval

功能为对用户输入的命令行求值计算，基本框架已经在课本上给出，只需要完善进程阻塞和具体处理即可。

- 首先定义所需变量，初始化阻塞信号集合，将SIGCHLD加入mask_one，将所有信号加入mask_all

- 调用parseline解析cmdline

- 调用builtin_cmd检查第一个命令行参数是否是一个内置的shell指令。如果是，指令直接在builtin_cmd函数内被解释完成，eval的工作结束

- 如果不是，需要创建一个子进程来执行请求的程序    
    - 由于要在此进程addjob，因此要先阻塞SIGCHLD防止竞争
    - fork()返回0说明这是子进程，使用setpgid创建一个新的进程组，解除进程阻塞，使用execve执行cmdline，无可执行文件则打印信息退出
    - 接下来要修改jobs相关的全局变量，因此先阻塞所有信号，再addjob
    - 如果用户要求cmdline前台执行，则调用waitfg等候子进程结束
    - 如果用户要求后台执行，使用getjobpid函数获取任务信息，按rtest给出的格式打印
    - 处理结束，解除阻塞

## builtin_cmd

功能为判断第一个命令行参数是否为内置的shell指令，是则立即解释并返回1，否则返回0，类似一个cmdline分类器。课本上同样给出了基本实现，只要再增加几种情况即可。

shell lab中的shell内置的命令包括quit、jobs、bg、fg。

- 如果argv[0]为quit，直接退出

- 如果argv[0]为jobs，按要求调用listjobs打印所有jobs信息，返回1

- 如果argv[0]为bg或fg，调用do_bgfg处理，返回1

- 如果argv[0]不满足上述情况，返回0

## do_bgfg

功能为执行bg和fg指令。

## waitfg

功能为等待前台程序运行结束。

## sigchld_handler

功能为响应SIGCHLD

## sigint_handler

功能为响应SIGINT(Ctrl+C)

## sigtstp_handler

功能为响应SIGTSTP(Ctrl+Z)